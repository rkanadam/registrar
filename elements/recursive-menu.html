<dom-module id="recursive-menu">
    <template>
        <style is="custom-style" include="app-theme"></style>
        <paper-menu id="menu" selected-item="{{selectedPage}}" attr-for-selected="id" selected="{{selectedPageId}}">
            <template is="dom-repeat" items="[[items]]" as="menu">
                <paper-submenu>
                    <paper-item menu="[[menu]]" class="menu-trigger">[[menu.label]]</paper-item>
                    <div style="padding-left: 10px" class="menu-content">
                        <recursive-menu id="submenu" items="[[menu.children]]"
                                        selected-item="{{selectedMenuItem}}"></recursive-menu>
                    </div>
                </paper-submenu>
            </template>
        </paper-menu>
    </template>
    <script>
        Polymer({
            is: 'recursive-menu',

            properties: {
                items: {
                    type: Array,
                    value: [],
                    notify: true
                },
                attrForSelected: {
                    type: String,
                    notify: true
                },
                selectedPath: {
                    type: String,
                    notify: true,
                    observer: '_onSelectedPathChanged'
                },
                selectedItem: {
                    type: Object,
                    notify: true
                },

                selectedMenuItem: {
                    type: Object,
                    observer: "_onSelectedMenuItemChanged"
                }
            },

            behaviors: [
                AppBehaviors.PageNavigationBehavior
            ],

            observers: [
                "_childrenChanged(items.*)"
            ],

            _childrenChanged: function () {
                console.log("items changed", this);
            },


            _onSelectedPathChanged: function () {
                if (this.selectedPath) {
                    var parts = this.selectedPath.split("/");
                    if (parts) {
                        var first = parts.shift();
                        var childIndex = _.findIndex(this.items, {id: first});
                        if (childIndex >= 0) {
                            this.$.menu.set("selected", childIndex);
                            this.selectedMenuItem.set("active", true);
                        }
                        if (this.items.length) {
                            if (parts.length) {
                                this.$.submenu.set("selectedPath", parts.join("/"));
                            }
                        }
                    }
                }
            },

            _onSelectedMenuItemChanged: function () {
                if (this.selectedMenuItem) {
                    this.set("selectedItem", this.selectedMenuItem.menu);
                }
            },

            _hasChildren: function (children) {
                return children && children.length > 0;
            }
        });
    </script>
</dom-module>