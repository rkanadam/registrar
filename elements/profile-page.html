<dom-module id="profile-page">
    <template>
        <style include="iron-flex iron-flex-alignment">
            paper-button {
                background: var(--paper-purple-900);
                color: white;
            }

            label {
                align-self: center;
                font-family: 'Roboto';
                color: var(--paper-input-container-color, --secondary-text-color);
            }

            spinner-backdrop {
                --spinner-backdrop-overlay-color: var(--paper-purple-50);
            }

            paper-dialog.save {
                padding: 5vh 5vh;
                z-index: 105;
            }
        </style>
        <paper-dialog id="saveDialog" class="save" modal on-iron-overlay-opened="_patchOverlay">
            <div class="layout vertical">
                <div class="layout horizontal center-justified">
                    <animated-check></animated-check>
                    <paper-item>[[localize('profileSavedMessage')]]</paper-item>
                </div>
                <br>
                <div class="layout horizontal center-justified">
                    <paper-button class="" raised onclick="saveDialog.close()">[[localize('close')]]</paper-button>
                </div>
            </div>
        </paper-dialog>
        <div style="padding: 0px 20px 20px 20px;position: relative;">
            <spinner-backdrop id="spinner" loading="[[loading]]"></spinner-backdrop>
            <iron-form method="get" action="/" id="basic" class="layout vertical" style="position: relative;">
                <input type="hidden" name="_id" value="[[profile._id]]">
                <paper-input name="firstName" label="{{localize('firstName')}}" required
                             value="{{profile.firstName}}"></paper-input>
                <br>
                <paper-input name="lastName" label="{{localize('lastName')}}" required
                             value="{{profile.lastName}}"></paper-input>
                <br>
                <div class="layout horizontal">
                    <label id="gender">[[localize('gender')]]</label>
                    <paper-radio-group aria-labelledby="gender" selected="{{profile.gender}}">
                        <paper-radio-button name="male">[[localize('male')]]</paper-radio-button>
                        <paper-radio-button name="female">[[localize('female')]]</paper-radio-button>
                    </paper-radio-group>
                </div>
                <paper-dropdown-menu label="[[localize('age')]]" name="age" required horizontal-align="left"
                                     value="{{profile.age}}" attr-for-selected="value">
                    <paper-listbox class="dropdown-content" selected="[[profile.age]]" attr-for-selected="label">
                        <paper-item label="0-4">0 - 4 [[localize('years')]]</paper-item>
                        <paper-item label="4-10">4 - 10 [[localize('years')]]</paper-item>
                        <paper-item label="11-14">11 - 14 [[localize('years')]]</paper-item>
                        <paper-item label="14-17">14 - 17 [[localize('years')]]</paper-item>
                        <paper-item label="18-25">18 - 25 [[localize('years')]]</paper-item>
                        <paper-item label="26-35">26 - 35 [[localize('years')]]</paper-item>
                        <paper-item label="36-60">36 - 60 [[localize('years')]]</paper-item>
                        <paper-item label="60-99">60+ [[localize('years')]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <br/>
                <vaadin-combo-box label="[[localize('country')]]"
                                  name="country"
                                  items="[[_getCountries(countries)]]"
                                  item-label-path="label"
                                  item-value-path="name"
                                  selected-item="{{country}}"
                                  value="{{profile.country}}"
                                  class="flex"
                ></vaadin-combo-box>
                <paper-input class="flex" name="zone" label="{{localize('zone')}}" required
                             value="[[_computeZoneLabel(profile.zone)]]" readonly></paper-input>
                <br>
                <paper-checkbox checked="{{profile.primary}}">[[localize('primaryProfile')]]</paper-checkbox>
                <div class="layout horizontal" style="margin: auto;">
                    <paper-button raised onclick="saveRequest.generateRequest ()">[[localize('save')]]</paper-button>
                    <paper-button raised on-click="_onReset">[[localize('reset')]]</paper-button>
                </div>
            </iron-form>
            <iron-ajax auto
                       handle-as="json"
                       url="../bower_components/Countries/countries.min.json"
                       on-response="_onCountriesFetch"
                       last-response="{{countries}}"
                       bubbles
            ></iron-ajax>
            <iron-ajax id="zonesRequest"
                       handle-as="json"
                       url="../zones.json"
                       last-response="{{zones}}"
                       bubbles
            ></iron-ajax>
            <iron-ajax
                    id="saveRequest"
                    method="POST"
                    url="[[_computeSaveUrl(profile)]]"
                    content-type="application/json"
                    handle-as="json"
                    last-response="{{profile}}"
                    on-response="_onSave"
                    on-error="_onSaveError"
                    body="[[profile]]"
                    bubbles
            ></iron-ajax>

        </div>
    </template>
    <script>
        Polymer({

            is: 'profile-page',

            properties: {
                profile: {
                    type: Object
                },

                language: {
                    type: String,
                    value: 'en'
                },

                country: {
                    type: Object
                },

                countries: {
                    type: Object
                },

                zones: {
                    type: Object
                },

                loading: {
                    type: Boolean,
                    value: false
                }
            },

            observers: [
                '_onCountryChanged(country)',
                '_onProfileChanged(profile)'
            ],

            behaviors: [
                Polymer.AppLocalizeBehavior
            ],

            listeners: {
                "request": "_onAjaxRequest",
                "response": "_onAjaxResponse",
                "error": "_onAjaxError"
            },

            _onAjaxRequest: function () {
                this.set("loading", true);
            },

            _onAjaxResponse: function () {
                this.set("loading", false);
            },

            _onAjaxError: function () {
                this.set("loading", false);
            },

            _patchOverlay: function (e) {
                if (e.target.withBackdrop) {
                    e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
                }
            },

            attached: function () {
                this.loadResources(this.resolveUrl('../locales.json'));
            },

            _onCountriesFetch: function () {
                this.$.zonesRequest.generateRequest();
            },

            _getCountries: function (countries) {
                if (!countries || !countries.countries) return [];
                var list = [];
                for (var key in countries.countries) {
                    var country = countries.countries[key];
                    country.label = country.native !== country.name ? country.native + " (" + country.name + ")" : country.name;
                    list.push(country);
                }
                return list;
            },

            _onCountryChanged: function (country) {
                if (country) {
                    var country = country.name;
                    if (this.zones) {
                        for (var zone in this.zones) {
                            if (this.zones[zone].countries.indexOf(country) !== -1) {
                                this.set("profile.zone", zone);
                                return;
                            }
                        }
                    }
                }

                this.set("profile.zone", "NA");
            },

            _computeZoneLabel: function (zone) {
                if (zone && this.zones[zone]) {
                    return this.zones[zone].name + " (" + this.zones[zone].president + ")";
                } else if (zone === "NA") {
                    return this.localize("na");
                }
                return "";
            },

            _onProfileChanged: function (profile) {
                if (profile) {
                    this.previousProfile = JSON.stringify(profile);
                }
            },

            _onReset: function () {
                if (this.previousProfile) {
                    var profile = JSON.parse(this.previousProfile);
                    this.previousProfile = null;
                    this.set("profile", profile);
                }
            },

            _onSave: function () {
                this.$.saveDialog.open();
            },

            _onSaveError: function () {
                debugger;
            },


            _computeSaveUrl: function (profile) {
                return "api.php/profile/" + (profile && profile._id ? profile._id : "");
            }
        });
    </script>
</dom-module>