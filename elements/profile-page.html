<dom-module id="profile-page">
    <style include="app-theme"></style>
    <template>
        <success-dialog id="saveDialog" msg-key="profileSavedMessage"></success-dialog>
        <div style="padding: 0px 20px 0px 20px;position: relative;height: 100%;">
            <spinner-backdrop id="spinner" loading="[[loading]]"></spinner-backdrop>
            <iron-form method="get" action="/" id="basic" class="layout vertical" style="height: 100%">
                <input type="hidden" name="_id" value="[[profile._id]]">
                <paper-input name="firstName" label="{{localize('firstName')}}" required
                             value="{{profile.firstName}}"></paper-input>
                <paper-input name="lastName" label="{{localize('lastName')}}" required
                             value="{{profile.lastName}}"></paper-input>
                <div>
                    <label id="gender">[[localize('gender')]]</label>
                    <paper-radio-group aria-labelledby="gender" selected="{{profile.gender}}">
                        <paper-radio-button name="male">[[localize('male')]]</paper-radio-button>
                        <paper-radio-button name="female">[[localize('female')]]</paper-radio-button>
                    </paper-radio-group>
                </div>
                <paper-dropdown-menu label="[[localize('age')]]" name="age" required horizontal-align="left"
                                     value="{{profile.age}}" attr-for-selected="value">
                    <paper-listbox class="dropdown-content" selected="[[profile.age]]" attr-for-selected="label">
                        <paper-item label="0-4">0 - 4 [[localize('years')]]</paper-item>
                        <paper-item label="4-10">4 - 10 [[localize('years')]]</paper-item>
                        <paper-item label="11-14">11 - 14 [[localize('years')]]</paper-item>
                        <paper-item label="14-17">14 - 17 [[localize('years')]]</paper-item>
                        <paper-item label="18-25">18 - 25 [[localize('years')]]</paper-item>
                        <paper-item label="26-35">26 - 35 [[localize('years')]]</paper-item>
                        <paper-item label="36-60">36 - 60 [[localize('years')]]</paper-item>
                        <paper-item label="60-99">60+ [[localize('years')]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <vaadin-combo-box label="[[localize('country')]]"
                                  name="country"
                                  items="[[_getCountries(countries)]]"
                                  item-label-path="label"
                                  item-value-path="name"
                                  selected-item="{{country}}"
                                  value="{{profile.country}}"
                ></vaadin-combo-box>
                <paper-input name="zone" label="{{localize('zone')}}" required
                             value="[[_computeZoneLabel(profile.zone)]]" readonly></paper-input>
                <paper-checkbox checked="{{profile.primary}}">[[localize('primaryProfile')]]</paper-checkbox>
                <div class="flex layout horizontal center-center">
                    <paper-button primary raised onclick="saveRequest.generateRequest ()">[[localize('save')]]
                    </paper-button>
                    <paper-button secondary raised on-click="_onReset">[[localize('reset')]]</paper-button>
                </div>
            </iron-form>
            <iron-ajax auto
                       handle-as="json"
                       url="../bower_components/Countries/countries.min.json"
                       on-response="_onCountriesFetch"
                       last-response="{{countries}}"
                       bubbles
            ></iron-ajax>
            <iron-ajax id="zonesRequest"
                       handle-as="json"
                       url="../zones.json"
                       last-response="{{zones}}"
                       bubbles
            ></iron-ajax>
            <iron-ajax
                    id="saveRequest"
                    method="POST"
                    url="[[_computeSaveUrl(profile)]]"
                    content-type="application/json"
                    handle-as="json"
                    last-response="{{profile}}"
                    on-response="_onSave"
                    on-error="_onSaveError"
                    body="[[profile]]"
                    bubbles
            ></iron-ajax>
        </div>
    </template>
    <script>
        Polymer({

            is: 'profile-page',

            properties: {
                profile: {
                    type: Object
                },

                language: {
                    type: String,
                    value: 'en'
                },

                country: {
                    type: Object
                },

                countries: {
                    type: Object
                },

                zones: {
                    type: Object
                },

                loading: {
                    type: Boolean,
                    value: false
                }
            },

            observers: [
                '_onCountryChanged(country)',
                '_onProfileChanged(profile)'
            ],

            behaviors: [
                AppBehaviors.AppBehavior
            ],

            _onCountriesFetch: function () {
                this.$.zonesRequest.generateRequest();
            },

            _getCountries: function (countries) {
                if (!countries || !countries.countries) return [];
                var list = [];
                for (var key in countries.countries) {
                    var country = countries.countries[key];
                    country.label = country.native !== country.name ? country.native + " (" + country.name + ")" : country.name;
                    list.push(country);
                }
                return list;
            },

            _onCountryChanged: function (country) {
                if (country) {
                    var country = country.name;
                    if (this.zones) {
                        for (var zone in this.zones) {
                            if (this.zones[zone].countries.indexOf(country) !== -1) {
                                this.set("profile.zone", zone);
                                return;
                            }
                        }
                    }
                }

                this.set("profile.zone", "NA");
            },

            _computeZoneLabel: function (zone) {
                if (typeof(this.localize) === "function") {
                    if (zone && this.zones && this.zones[zone]) {
                        return this.zones[zone].name + " (" + this.zones[zone].president + ")";
                    } else if (zone === "NA") {
                        return this.localize("na");
                    }
                }
                return "";
            },

            _onProfileChanged: function (profile) {
                if (profile) {
                    this.previousProfile = JSON.stringify(profile);
                }
            },

            _onReset: function () {
                if (this.previousProfile) {
                    var profile = JSON.parse(this.previousProfile);
                    this.previousProfile = null;
                    this.set("profile", profile);
                }
            },

            _onSave: function () {
                this.$.saveDialog.open();
            },

            _onSaveError: function () {
                debugger;
            },

            _computeSaveUrl: function (profile) {
                return "api.php/profile/" + (profile && profile._id ? profile._id : "");
            }
        });
    </script>
</dom-module>